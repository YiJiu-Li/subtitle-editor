version: '3.8'

services:
  subtitle-editor:
    build:
      context: .
      dockerfile: Dockerfile
    image: subtitle-editor:latest
    container_name: subtitle-editor
    
    # 端口映射 (宿主机端口:容器端口)
    ports:
      - "17830:3000"
    
    # 数据卷挂载
    volumes:
      - ./uploads:/app/uploads          # 上传文件目录
      - ./whisper-models:/root/.cache/huggingface  # Whisper模型缓存（避免重复下载）
    
    # 环境变量
    environment:
      - NODE_ENV=production             # Node.js 生产模式
      - TZ=Asia/Shanghai                # 时区设置
      - WHISPER_MODELS_DIR=/root/.cache/huggingface  # 模型缓存目录（映射自宿主机）
      - WHISPER_MODEL=base              # 默认模型: tiny/base/small/medium/large
      # 前端可动态选择模型，无需重启容器！支持: tiny, base, small, medium, large
    
    # 资源限制
    deploy:
      resources:
        limits:
          memory: 4G                    # 内存上限（Whisper需要较多内存）
          cpus: '2'                     # CPU核心数上限
        reservations:
          memory: 1G                    # 最小保留内存
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s                     # 检查间隔
      timeout: 10s                      # 超时时间
      retries: 3                        # 重试次数
      start_period: 60s                 # 启动等待时间（首次构建需要下载模型）
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"                 # 单个日志文件最大10MB
        max-file: "3"                   # 最多保留3个日志文件
    
    # 重启策略
    restart: unless-stopped
    
    # 网络配置
    networks:
      - subtitle-net

networks:
  subtitle-net:
    driver: bridge
